cmake_minimum_required(VERSION 3.16)
project(GraphVisualizer)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

set(QT_DIR "C:/6.5.2/mingw_64")  

find_package(Qt6 REQUIRED COMPONENTS Core Widgets)

set(APP_SOURCES
    main.cpp  
    ui/mainwindow.cpp     
    ui/mainwindow.h       
    ui/customscene.cpp    
    ui/customscene.h      
    ui/draggablevertex.cpp 
    ui/draggablevertex.h  
)

set(GRAPH_SOURCES
    graph/graph.cpp
    graph/graph.h
    structs_for_graph/structs_for_graph.cpp
    structs_for_graph/structs_for_graph.h
    errors/errors.cpp
    errors/errors.h
)

add_executable(GraphVisualizer WIN32
    ${APP_SOURCES}
    ${GRAPH_SOURCES}
)

target_include_directories(GraphVisualizer PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/graph
    ${CMAKE_CURRENT_SOURCE_DIR}/structs_for_graph
    ${CMAKE_CURRENT_SOURCE_DIR}/errors
    ${CMAKE_CURRENT_SOURCE_DIR}/ui    
)

target_link_libraries(GraphVisualizer PRIVATE
    Qt6::Core
    Qt6::Widgets
)

if(WIN32)
    function(copy_qt6_dll target)
        if(TARGET Qt6::Core)
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "$<TARGET_FILE:Qt6::Core>"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
        endif()
        
        if(TARGET Qt6::Widgets)
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "$<TARGET_FILE:Qt6::Widgets>"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
        endif()
        
        if(EXISTS "${QT_DIR}/plugins/platforms/qwindows.dll")
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E make_directory
                "$<TARGET_FILE_DIR:${target}>/platforms"
                VERBATIM
            )
            
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${QT_DIR}/plugins/platforms/qwindows.dll"
                "$<TARGET_FILE_DIR:${target}>/platforms/"
                VERBATIM
            )
        endif()
        
        if(MINGW)
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_CXX_COMPILER}/../libstdc++-6.dll"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_CXX_COMPILER}/../libgcc_s_seh-1.dll"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_CXX_COMPILER}/../libwinpthread-1.dll"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
        endif()
    endfunction()

    copy_qt6_dll(GraphVisualizer)
endif()

file(MAKE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/data)

message(STATUS "Project configured successfully")

if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/data")
    add_custom_command(TARGET GraphVisualizer POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_directory
        "${CMAKE_CURRENT_SOURCE_DIR}/data"
        "$<TARGET_FILE_DIR:GraphVisualizer>/data"
        VERBATIM
    )
endif()