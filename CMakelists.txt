cmake_minimum_required(VERSION 3.16)
project(GraphVisualizer)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# Укажите правильный путь к Qt6
# ЗАМЕНИТЕ этот путь на ваш реальный путь к Qt
set(QT_DIR "C:/6.5.2/mingw_64")  # ИЗМЕНИТЕ ЭТУ СТРОКУ!

find_package(Qt6 REQUIRED COMPONENTS Core Widgets)

# Файлы приложения
set(APP_SOURCES
    main.cpp
    mainwindow.cpp
    mainwindow.h
    customscene.cpp
    customscene.h
)

# Файлы графа
set(GRAPH_SOURCES
    graph/graph.cpp
    graph/graph.h
    structs_for_graph/structs_for_graph.cpp
    structs_for_graph/structs_for_graph.h
    errors/errors.cpp
    errors/errors.h
)

# WIN32 для GUI приложения
add_executable(GraphVisualizer WIN32
    ${APP_SOURCES}
    ${GRAPH_SOURCES}
)

# Добавляем include директории
target_include_directories(GraphVisualizer PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/graph
    ${CMAKE_CURRENT_SOURCE_DIR}/structs_for_graph
    ${CMAKE_CURRENT_SOURCE_DIR}/errors
)

target_link_libraries(GraphVisualizer PRIVATE
    Qt6::Core
    Qt6::Widgets
)

# Автоматически копируем нужные DLL
if(WIN32)
    # Функция для копирования Qt DLL
    function(copy_qt6_dll target)
        if(TARGET Qt6::Core)
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "$<TARGET_FILE:Qt6::Core>"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
        endif()
        
        if(TARGET Qt6::Widgets)
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "$<TARGET_FILE:Qt6::Widgets>"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
        endif()
        
        # Копируем платформенные плагины
        if(EXISTS "${QT_DIR}/plugins/platforms/qwindows.dll")
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E make_directory
                "$<TARGET_FILE_DIR:${target}>/platforms"
                VERBATIM
            )
            
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${QT_DIR}/plugins/platforms/qwindows.dll"
                "$<TARGET_FILE_DIR:${target}>/platforms/"
                VERBATIM
            )
        endif()
        
        # Для MinGW копируем дополнительные DLL
        if(MINGW)
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_CXX_COMPILER}/../libstdc++-6.dll"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_CXX_COMPILER}/../libgcc_s_seh-1.dll"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
            add_custom_command(TARGET ${target} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_CXX_COMPILER}/../libwinpthread-1.dll"
                $<TARGET_FILE_DIR:${target}>
                VERBATIM
            )
        endif()
    endfunction()
    
    # Вызываем функцию для нашего приложения
    copy_qt6_dll(GraphVisualizer)
endif()

# Создаем папку для данных
file(MAKE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/data)

message(STATUS "Project configured successfully")

# Копируем папку data с файлами городов
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/data")
    add_custom_command(TARGET GraphVisualizer POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_directory
        "${CMAKE_CURRENT_SOURCE_DIR}/data"
        "$<TARGET_FILE_DIR:GraphVisualizer>/data"
        VERBATIM
    )
endif()